; Database schema for WebIssues Server

[alerts]
alert_id        = INTEGER auto-increment=1
user_id         = INTEGER ref-table="users" ref-column="user_id"
folder_id       = INTEGER ref-table="folders" ref-column="folder_id" on-delete="cascade"
view_id         = INTEGER null=1 ref-table="views" ref-column="view_id" on-delete="cascade"
alert_email     = INTEGER size="tiny"
stamp_id        = INTEGER null=1
pk              = PRIMARY columns={"alert_id"}
alert_idx       = INDEX columns={"user_id","folder_id","view_id"} unique=1
folder_idx      = INDEX columns={"folder_id"}
view_idx        = INDEX columns={"view_id"}

[attr_types]
attr_id         = INTEGER auto-increment=1
type_id         = INTEGER ref-table="issue_types" ref-column="type_id" on-delete="cascade"
attr_name       = VARCHAR length=40
attr_def        = TEXT size="long"
pk              = PRIMARY columns={"attr_id"}
type_idx        = INDEX columns={"type_id"}
name_idx        = INDEX columns={"attr_name"}

[attr_values]
issue_id        = INTEGER ref-table="issues" ref-column="issue_id" on-delete="cascade"
attr_id         = INTEGER ref-table="attr_types" ref-column="attr_id" on-delete="cascade"
attr_value      = VARCHAR length=255
pk              = PRIMARY columns={"issue_id","attr_id"}
attr_idx        = INDEX columns={"attr_id"}

[change_stubs]
stub_id         = INTEGER ref-table="stamps" ref-column="stamp_id"
change_id       = INTEGER
issue_id        = INTEGER ref-table="issues" ref-column="issue_id" on-delete="cascade"
pk              = PRIMARY columns={"stub_id"}
issue_idx       = INDEX columns={"issue_id"}

[changes]
change_id       = INTEGER ref-table="stamps" ref-column="stamp_id"
issue_id        = INTEGER ref-table="issues" ref-column="issue_id" on-delete="cascade"
change_type     = INTEGER size="tiny"
stamp_id        = INTEGER
attr_id         = INTEGER null=1 ref-table="attr_types" ref-column="attr_id" on-delete="set-null"
value_old       = VARCHAR length=255 null=1
value_new       = VARCHAR length=255 null=1
from_folder_id  = INTEGER null=1 ref-table="folders" ref-column="folder_id" on-delete="set-null"
to_folder_id    = INTEGER null=1 ref-table="folders" ref-column="folder_id" on-delete="set-null"
pk              = PRIMARY columns={"change_id"}
issue_idx       = INDEX columns={"issue_id","change_type"}
stamp_idx       = INDEX columns={"stamp_id"}
attr_idx        = INDEX columns={"attr_id"}
from_folder_idx = INDEX columns={"from_folder_id"}
to_folder_idx   = INDEX columns={"to_folder_id"}

[comments]
comment_id      = INTEGER ref-table="changes" ref-column="change_id" on-delete="cascade"
comment_text    = TEXT size="long"
pk              = PRIMARY columns={"comment_id"}

[files]
file_id         = INTEGER ref-table="changes" ref-column="change_id" on-delete="cascade"
file_name       = VARCHAR length=80
file_size       = INTEGER
file_data       = BLOB size="long" null=1
file_descr      = VARCHAR length=255
file_storage    = INTEGER size="tiny"
pk              = PRIMARY columns={"file_id"}

[folders]
folder_id       = INTEGER auto-increment=1
project_id      = INTEGER ref-table="projects" ref-column="project_id" on-delete="cascade"
type_id         = INTEGER ref-table="issue_types" ref-column="type_id" on-delete="cascade"
folder_name     = VARCHAR length=40
stamp_id        = INTEGER null=1
pk              = PRIMARY columns={"folder_id"}
project_idx     = INDEX columns={"project_id"}
type_idx        = INDEX columns={"type_id"}
name_idx        = INDEX columns={"folder_name"}

[issue_states]
state_id        = INTEGER auto-increment=1
user_id         = INTEGER ref-table="users" ref-column="user_id"
issue_id        = INTEGER ref-table="issues" ref-column="issue_id" on-delete="cascade"
read_id         = INTEGER null=1
pk              = PRIMARY columns={"state_id"}
state_idx       = INDEX columns={"user_id","issue_id"} unique=1
issue_idx       = INDEX columns={"issue_id"}

[issue_stubs]
stub_id         = INTEGER ref-table="stamps" ref-column="stamp_id"
prev_id         = INTEGER
issue_id        = INTEGER
folder_id       = INTEGER ref-table="folders" ref-column="folder_id" on-delete="cascade"
pk              = PRIMARY columns={"stub_id"}
folder_idx      = INDEX columns={"folder_id"}

[issue_types]
type_id         = INTEGER auto-increment=1
type_name       = VARCHAR length=40
pk              = PRIMARY columns={"type_id"}
name_idx        = INDEX columns={"type_name"}

[issues]
issue_id        = INTEGER ref-table="stamps" ref-column="stamp_id"
folder_id       = INTEGER ref-table="folders" ref-column="folder_id" on-delete="cascade"
issue_name      = VARCHAR length=255
stamp_id        = INTEGER ref-table="stamps" ref-column="stamp_id"
stub_id         = INTEGER null=1
pk              = PRIMARY columns={"issue_id"}
folder_idx      = INDEX columns={"folder_id"}
stamp_idx       = INDEX columns={"stamp_id"}

[log_events]
event_id        = INTEGER auto-increment=1
event_type      = VARCHAR length=16 ascii=1
event_severity  = INTEGER size="tiny"
event_message   = TEXT size="long"
event_time      = INTEGER
user_id         = INTEGER null=1 ref-table="users" ref-column="user_id"
host_name       = VARCHAR length=40 ascii=1
pk              = PRIMARY columns={"event_id"}
type_idx        = INDEX columns={"event_type"}
user_idx        = INDEX columns={"user_id"}

[preferences]
user_id         = INTEGER ref-table="users" ref-column="user_id"
pref_key        = VARCHAR length=40
pref_value      = TEXT size="long"
pk              = PRIMARY columns={"user_id","pref_key"}

[projects]
project_id      = INTEGER auto-increment=1
project_name    = VARCHAR length=40
pk              = PRIMARY columns={"project_id"}
name_idx        = INDEX columns={"project_name"}

[rights]
project_id      = INTEGER ref-table="projects" ref-column="project_id" on-delete="cascade"
user_id         = INTEGER ref-table="users" ref-column="user_id"
project_access  = INTEGER size="tiny"
pk              = PRIMARY columns={"project_id","user_id"}
user_idx        = INDEX columns={"user_id"}

[server]
server_name     = VARCHAR length=40
server_uuid     = CHAR length=36 ascii=1
db_version      = VARCHAR length=20 ascii=1

[sessions]
session_id      = CHAR length=32 ascii=1
user_id         = INTEGER ref-table="users" ref-column="user_id"
session_data    = TEXT size="long"
last_access     = INTEGER
pk              = PRIMARY columns={"session_id"}
user_idx        = INDEX columns={"user_id"}
access_idx      = INDEX columns={"last_access"}

[settings]
set_key         = VARCHAR length=40
set_value       = TEXT size="long"
pk              = PRIMARY columns={"set_key"}

[stamps]
stamp_id        = INTEGER auto-increment=1
user_id         = INTEGER ref-table="users" ref-column="user_id"
stamp_time      = INTEGER
pk              = PRIMARY columns={"stamp_id"}
user_idx        = INDEX columns={"user_id"}

[users]
user_id         = INTEGER auto-increment=1
user_login      = VARCHAR length=40
user_name       = VARCHAR length=40
user_passwd     = VARCHAR length=255 ascii=1
user_access     = INTEGER size="tiny"
passwd_temp     = INTEGER size="tiny"
pk              = PRIMARY columns={"user_id"}
login_idx       = INDEX columns={"user_login"} unique=1
name_idx        = INDEX columns={"user_name"}

[view_settings]
type_id         = INTEGER ref-table="issue_types" ref-column="type_id" on-delete="cascade"
set_key         = VARCHAR length=40
set_value       = TEXT size="long"
pk              = PRIMARY columns={"type_id","set_key"}

[views]
view_id         = INTEGER auto-increment=1
type_id         = INTEGER ref-table="issue_types" ref-column="type_id" on-delete="cascade"
user_id         = INTEGER null=1 ref-table="users" ref-column="user_id"
view_name       = VARCHAR length=40
view_def        = TEXT size="long"
pk              = PRIMARY columns={"view_id"}
view_idx        = INDEX columns={"type_id","user_id"}
user_idx        = INDEX columns={"user_id"}
name_idx        = INDEX columns={"view_name"}
