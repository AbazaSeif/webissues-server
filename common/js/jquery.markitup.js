// ----------------------------------------------------------------------------
// markItUp! Universal MarkUp Engine, JQuery plugin
// v 1.1.x
// Dual licensed under the MIT and GPL licenses.
// ----------------------------------------------------------------------------
// Copyright (C) 2007-2012 Jay Salvat
// http://markitup.jaysalvat.com/
// ----------------------------------------------------------------------------
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
// 
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
// ----------------------------------------------------------------------------
(function(b){b.fn.markItUp=function(v,k){var d,w,x,I,c,u,A,B;u=A=B=!1;"string"==typeof v&&(x=v,I=k);c={id:"",nameSpace:"",root:"",previewHandler:!1,previewInWindow:"",previewInElement:"",previewAutoRefresh:!0,previewPosition:"after",previewTemplatePath:"~/templates/preview.html",previewParser:!1,previewParserPath:"",previewParserVar:"data",resizeHandle:!0,beforeInsert:"",afterInsert:"",onEnter:{},onShiftEnter:{},onCtrlEnter:{},onTab:{},markupSet:[{}]};b.extend(c,v,k);c.root||b("script").each(function(d,
j){miuScript=b(j).get(0).src.match(/(.*)jquery\.markitup(\.pack)?\.js$/);null!==miuScript&&(c.root=miuScript[1])});d=navigator.userAgent;d=d.toLowerCase();w=/(chrome)[ \/]([\w.]+)/.exec(d)||/(webkit)[ \/]([\w.]+)/.exec(d)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(d)||/(msie) ([\w.]+)/.exec(d)||0>d.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(d)||[];d=w[1]||"";w=w[2]||"0";var j={};d&&(j[d]=!0,j.version=w);j.chrome?j.webkit=!0:j.webkit&&(j.safari=!0);return this.each(function(){function d(a,
b){return b?a.replace(/("|')~\//g,"$1"+c.root):a.replace(/^~\//,c.root)}function k(a){var l=b("<ul></ul>"),f=0;b("li:hover > ul",l).css("display","block");b.each(a,function(){var a=this,d="",j,g;j=a.key?(a.name||"")+" [Ctrl+"+a.key+"]":a.name||"";key=a.key?'accesskey="'+a.key+'"':"";if(a.separator)d=b('<li class="markItUpSeparator">'+(a.separator||"")+"</li>").appendTo(l);else{f++;for(g=s.length-1;0<=g;g--)d+=s[g]+"-";d=b('<li class="markItUpButton markItUpButton'+d+f+" "+(a.className||"")+'"><a href="" '+
key+' title="'+j+'">'+(a.name||"")+"</a></li>").bind("contextmenu.markItUp",function(){return!1}).bind("click.markItUp",function(a){a.preventDefault()}).bind("focusin.markItUp",function(){e.focus()}).bind("mouseup",function(){"preview"==a.call&&("function"===typeof c.previewHandler?h=!0:c.previewInElement?h=b(c.previewInElement):!h||h.closed?c.previewInWindow?(h=window.open("","preview",c.previewInWindow),b(window).unload(function(){h.close()})):(m=b('<iframe class="markItUpPreviewFrame"></iframe>'),
"after"==c.previewPosition?m.insertAfter(G):m.insertBefore(r),h=m[m.length-1].contentWindow||frame[m.length-1]):!0===B&&(m?m.remove():h.close(),h=m=!1),c.previewAutoRefresh||J(),c.previewInWindow&&h.focus());setTimeout(function(){t(a)},1);return!1}).bind("mouseenter.markItUp",function(){b("> ul",this).show();b(document).one("click",function(){b("ul ul",r).hide()})}).bind("mouseleave.markItUp",function(){b("> ul",this).hide()}).appendTo(l);a.dropMenu&&(s.push(f),b(d).addClass("markItUpDropMenu").append(k(a.dropMenu)))}});
s.pop();return l}function n(a){b.isFunction(a)&&(a=a(C));a?(a=a.toString(),a=a.replace(/\(\!\(([\s\S]*?)\)\!\)/g,function(a,c){var b=c.split("|!|");return!0===B?void 0!==b[1]?b[1]:b[0]:void 0===b[1]?"":b[0]}),a=a.replace(/\[\!\[([\s\S]*?)\]\!\]/g,function(a,b){var c=b.split(":!:");if(!0===D)return!1;value=prompt(c[0],c[1]?c[1]:"");null===value&&(D=!0);return value})):a="";return a}function t(a){var l;C=p=a;E();b.extend(C,{line:"",root:c.root,textarea:f,selection:selection||"",caretPosition:g,ctrlKey:u,
shiftKey:A,altKey:B});n(c.beforeInsert);n(p.beforeInsert);!0===a.multiline&&n(p.beforeMultiInsert);b.extend(C,{line:1});var d=selection;l=n(p.openWith);var y=n(p.placeHolder),z=n(p.replaceWith),k=n(p.closeWith),m=n(p.openBlockWith),t=n(p.closeBlockWith),s=p.multiline;if(""!==z)block=l+z+k;else if(""===selection&&""!==y)block=l+y+k;else{var d=d||selection,r=[d],x=[];!0===s&&(r=d.split(/\r?\n/));for(d=0;d<r.length;d++){line=r[d];if(s=line.match(/[ \t]+$/))line=line.replace(/[ \t]+$/g,"");""!=line?x.push(l+
line+k+(s||"")):x.push(s||"")}block=x.join("\n")}if(r=block.match(/[ \t\r\n]+$/))block=block.replace(/[ \t\r\n]+$/g,"");block=m+block+t+(r||"");string={block:block,openBlockWith:m,openWith:l,replaceWith:z,placeHolder:y,closeWith:k,closeBlockWith:t};start=g+string.block.length;l=0;y=start;z=string.block;z=j.msie?z.length-z.replace(/\r*/g,"").length:0;start=y-z;""===selection&&""===string.replaceWith&&(q+=v(string.block),start=g+string.openBlockWith.length+string.openWith.length,l=string.block.length-
string.openBlockWith.length-string.openWith.length-string.closeWith.length-string.closeBlockWith.length,q=e.val().substring(g,e.val().length).length,q-=v(e.val().substring(0,g)));b.extend(C,{caretPosition:g,scrollPosition:F});string.block!==selection&&!1===D?(y=string.block,document.selection?document.selection.createRange().text=y:f.value=f.value.substring(0,g)+y+f.value.substring(g+selection.length,f.value.length),w(start,l)):q=-1;E();b.extend(C,{line:"",selection:selection});!0===a.multiline&&
n(p.afterMultiInsert);n(p.afterInsert);n(c.afterInsert);h&&c.previewAutoRefresh&&J();A=B=u=D=!1}function v(a){return j.opera?a.length-a.replace(/\n*/g,"").length:0}function w(a,b){if(f.createTextRange){if(j.opera&&9.5<=j.version&&0==b)return!1;range=f.createTextRange();range.collapse(!0);range.moveStart("character",a);range.moveEnd("character",b);range.select()}else f.setSelectionRange&&f.setSelectionRange(a,a+b);f.scrollTop=F;f.focus()}function E(){f.focus();F=f.scrollTop;if(document.selection)if(selection=
document.selection.createRange().text,j.msie){var a=document.selection.createRange(),b=a.duplicate();b.moveToElementText(f);for(g=-1;b.inRange(a);)b.moveStart("character"),g++}else g=f.selectionStart;else g=f.selectionStart,selection=f.value.substring(g,f.selectionEnd);return selection}function J(){if(c.previewHandler&&"function"===typeof c.previewHandler)c.previewHandler(e.val());else if(c.previewParser&&"function"===typeof c.previewParser){var a=c.previewParser(e.val());H(d(a,1))}else""!==c.previewParserPath?
b.ajax({type:"POST",dataType:"text",global:!1,url:c.previewParserPath,data:c.previewParserVar+"="+encodeURIComponent(e.val()),success:function(a){H(d(a,1))}}):L||b.ajax({url:c.previewTemplatePath,dataType:"text",global:!1,success:function(a){H(d(a,1).replace(/\x3c!-- content --\x3e/g,e.val()))}});return!1}function H(a){if(c.previewInElement)b(c.previewInElement).show(),b(c.previewInElement).html(a),"function"===typeof prettyPrint&&prettyPrint();else if(h&&h.document){try{sp=h.document.documentElement.scrollTop}catch(d){sp=
0}h.document.open();h.document.write(a);h.document.close();h.document.documentElement.scrollTop=sp}}function K(a){A=a.shiftKey;B=a.altKey;u=!a.altKey||!a.ctrlKey?a.ctrlKey||a.metaKey:!1;if("keydown"===a.type){if(!0===u&&(li=b('a[accesskey="'+(13==a.keyCode?"\\n":String.fromCharCode(a.keyCode))+'"]',r).parent("li"),0!==li.length))return u=!1,setTimeout(function(){li.triggerHandler("mouseup")},1),!1;if(13===a.keyCode||10===a.keyCode){if(!0===u)return u=!1,t(c.onCtrlEnter),c.onCtrlEnter.keepDefault;
if(!0===A)return A=!1,t(c.onShiftEnter),c.onShiftEnter.keepDefault;t(c.onEnter);return c.onEnter.keepDefault}if(9===a.keyCode){if(!0==A||!0==u||!0==B)return!1;if(-1!==q)return E(),q=e.val().length-q,w(q,0),q=-1,!1;t(c.onTab);return c.onTab.keepDefault}}}var e,f,s,F,g,q,p,C,r,G,h,L,m,D;e=b(this);f=this;s=[];D=!1;F=g=0;q=-1;c.previewParserPath=d(c.previewParserPath);c.previewTemplatePath=d(c.previewTemplatePath);if(x)switch(x){case "remove":e.unbind(".markItUp").removeClass("markItUpEditor");e.parent("div").parent("div.markItUp").parent("div").replaceWith(e);
e.data("markItUp",null);break;case "insert":t(I);break;default:b.error("Method "+x+" does not exist on jQuery.markItUp")}else nameSpace=id="",c.id?id='id="'+c.id+'"':e.attr("id")&&(id='id="markItUp'+e.attr("id").substr(0,1).toUpperCase()+e.attr("id").substr(1)+'"'),c.nameSpace&&(nameSpace='class="'+c.nameSpace+'"'),e.wrap("<div "+nameSpace+"></div>"),e.wrap("<div "+id+' class="markItUp"></div>'),e.wrap('<div class="markItUpContainer"></div>'),e.addClass("markItUpEditor"),r=b('<div class="markItUpHeader"></div>').insertBefore(e),
b(k(c.markupSet)).appendTo(r),G=b('<div class="markItUpFooter"></div>').insertAfter(e),!0===c.resizeHandle&&!0!==j.safari&&(resizeHandle=b('<div class="markItUpResizeHandle"></div>').insertAfter(e).bind("mousedown.markItUp",function(a){var c=e.height(),d=a.clientY,f,g;f=function(a){e.css("height",Math.max(20,a.clientY+c-d)+"px");return!1};g=function(){b("html").unbind("mousemove.markItUp",f).unbind("mouseup.markItUp",g);return!1};b("html").bind("mousemove.markItUp",f).bind("mouseup.markItUp",g)}),
G.append(resizeHandle)),e.bind("keydown.markItUp",K).bind("keyup",K),e.bind("insertion.markItUp",function(a,c){!1!==c.target&&E();f===b.markItUp.focused&&t(c)}),e.bind("focus.markItUp",function(){b.markItUp.focused=this})})};b.fn.markItUpRemove=function(){return this.each(function(){b(this).markItUp("remove")})};b.markItUp=function(v){var k={target:!1};b.extend(k,v);if(k.target)return b(k.target).each(function(){b(this).focus();b(this).trigger("insertion",[k])});b("textarea").trigger("insertion",
[k])}})(jQuery);